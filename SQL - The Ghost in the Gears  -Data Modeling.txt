---------------------------------
--- Homework #3
--- Zihao Li
---------------------------------

-- Set the context.
USE ROLE sysadmin;
USE investigation.PUBLIC;
USE WAREHOUSE ghosts_loading_wh;

-- Create the table
CREATE OR REPLACE TABLE phone_directory (
        directory_id integer,
        phone_number string,
        name string,
        address string,
        district string
);

-- Create the table
CREATE OR REPLACE TABLE call_log (
        call_id integer,
        caller_id integer,
        receiver_id integer,
        call_duration integer,
        call_start_date date,
        call_status string
);

---------------------------------
-- CREATING STAGES
---------------------------------
CREATE OR REPLACE STAGE investigation3651
        url = 's3://investigation-3651/';

LIST @investigation3651;

---------------------------------
-- CREATING FILE FORMATS
---------------------------------
CREATE OR REPLACE FILE FORMAT ghosts_csv
        type = 'csv'
        field_delimiter = ',' -- Columns are separated by commas
        skip_header = 1 -- Skip the first line in the file
        trim_space = true -- Remove white space from fields
        null_if = ('-') -- Treat dashes as SQL NULL
        field_optionally_enclosed_by = '"' -- Strings may be enclosed in double quotes
;

---------------------------------
-- LOADING DATA
---------------------------------

-- Use a COPY COMMAND to load data into the table.
COPY INTO call_log -- the destination table
FROM @investigation3651/call_log.csv -- the source stage
file_format = (null_if = ('N/A'), skip_header = 1);-- the file format

-- Use a COPY COMMAND to load data into the table.
COPY INTO phone_directory -- the destination table
FROM @investigation3651/phone_directory.csv -- the source stage
file_format = ghosts_csv; -- the file format

--Switch to the warehouse for querying data.
USE WAREHOUSE ghosts_query_wh;

------------------------------------------------------

---Count the number of calls.
SELECT COUNT(*) FROM call_log;
---How many calls are in the data?
---398390

---Determine the time span of the call data. (On what day was the first and last call made?)
SELECT MIN(CALL_START_DATE),MAX(CALL_START_DATE) FROM call_log;
---What is the date of the last call? (Use this format: MM/DD/YY.)
---2023-12-30

---Calculate the % of calls that were answered.
SELECT
call_status,
COUNT(call_status),
COUNT(call_status)+LEAD(count(call_status)) OVER(ORDER BY(call_status)) AS TOTAL,
COUNT(call_status)/TOTAL*100
FROM call_log
GROUP BY call_status;
---What % of calls were answered? (Enter a % and round to the nearest whole number.)
---78%


---Calculate average call duration in minutes. 
SELECT
call_status,
SUM(CALL_DURATION)/60/COUNT(call_status) as average_call_duration ,
FROM call_log
GROUP BY call_status
HAVING call_status = 'answered' ;
---What was the average duration in minutes? (Round to one decimal place.)
---11

---Calculate call volume by month. 
SELECT
EXTRACT(year from CALL_START_DATE) AS YEAR,
EXTRACT(month from CALL_START_DATE) AS MONTH,
COUNT(*) AS monthly_total,
SUM(monthly_total) OVER (ORDER BY YEAR,MONTH) AS running_total
FROM call_log
GROUP BY YEAR,MONTH
ORDER BY YEAR,MONTH;
---By the end of June 2023, how many calls had been made?
---198010




---Calculate outbound call volume by district. (Store results in Excel.)
SELECT
DISTRICT,
Count(*) as total_call
FROM call_log
Left JOIN phone_directory
ON CALLER_ID=DIRECTORY_ID
GROUP BY DISTRICT
ORDER BY total_call
;
---What was the total outbound call volume for the "Tech Hub" district?
---12794


CREATE or replace VIEW victim_detail_view    
AS SELECT 
vp.victim_id,
vp.victim_name,
vp.address,
cd.date AS homicide_date,
pd.directory_id
FROM victim_profiles as vp
JOIN crime_details as cd
ON vp.victim_id=cd.victim_id
JOIN phone_directory as pd
ON vp.ADDRESS=pd.ADDRESS;




