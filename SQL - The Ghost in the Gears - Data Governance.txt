---------------------------------
--- Homework #6
--- Zihao Li
---------------------------------

-- Set the context.
USE ROLE sysadmin;
USE investigation.PUBLIC;
USE WAREHOUSE ghosts_loading_wh;


---------------------------------------------------
-- CREATE A RESOURCE MONITOR 
---------------------------------------------------

-- Switch to the account admin role.
USE ROLE accountadmin;

-- Create a resource monitor
CREATE OR REPLACE RESOURCE MONITOR ghosts_rm
WITH CREDIT_QUOTA = 200
     FREQUENCY = monthly
     START_TIMESTAMP = immediately
     TRIGGERS 
        ON 80 PERCENT DO NOTIFY -- notify admins
        ON 100 PERCENT DO SUSPEND_IMMEDIATE; -- suspend (cancel queries)

-- Apply a resource monitor to our warehouse
ALTER WAREHOUSE ghosts_query_wh
SET RESOURCE_MONITOR = ghosts_rm;

-- List our warehouses. 
SHOW WAREHOUSES;


---------------------------------------------------
-- PROTECT THE WAREHOUSE FROM LONG-RUNNING QUERIES
---------------------------------------------------

-- Check the warehouse statement parameters
SHOW PARAMETERS LIKE '%statement%' IN WAREHOUSE ghosts_query_wh;

-- Adjust the statement timeout parameter
ALTER WAREHOUSE ghosts_query_wh SET statement_timeout_in_seconds = 3600;

-- Adjusted the statement queued timeout parameter
ALTER WAREHOUSE ghosts_query_wh SET statement_queued_timeout_in_seconds = 900;

-- Recheck the warehouse statement parameters
SHOW PARAMETERS LIKE '%statement%' IN WAREHOUSE ghosts_query_wh;


---------------------------------------------------
-- CREATE A ROLE & GRANT PRIVILEGES
---------------------------------------------------

-- Switch to the "useradmin" role to create our test role
USE ROLE useradmin;

-- Create a test role
CREATE OR REPLACE ROLE ghosts_query_role;

-- Add the new test role to our user account
SET my_user = CURRENT_USER();
GRANT ROLE ghosts_query_role TO USER identified($my_user);

---List all roles using the “show” function.
SHOW ROLES;
---For our new role, what is the value for the "assigned_to_users" field?
---1

-- Switch to the "securityadmin" role to grant privileges
USE ROLE SECURITYADMIN;

-- Grant warehouse privileges
GRANT OPERATE, USAGE ON WAREHOUSE ghosts_query_wh TO ROLE ghosts_query_role;

-- Grant database, schema, and table privileges
GRANT USAGE ON DATABASE investigation TO ROLE ghosts_query_role;
GRANT USAGE ON ALL SCHEMAS IN DATABASE investigation TO ROLE ghosts_query_role;
GRANT SELECT ON ALL TABLES IN SCHEMA investigation.public TO ROLE ghosts_query_role;
GRANT SELECT ON ALL VIEWS IN SCHEMA investigation.public TO ROLE ghosts_query_role;


-- Switch to the test user and attempt to query a table
USE ROLE ghosts_query_role;
USE WAREHOUSE ghosts_query_wh;

Select * from victim_detail_view;
---Where did Anne Richardson live?
---203 Heights Ave, Northern

USE role sysadmin;
USE WAREHOUSE ghosts_loading_wh;

---Create a new view called “calls_to_victims_by_officials”. (Condition #1)
CREATE or replace VIEW calls_to_victims_by_officials  
AS SELECT 
*
FROM 
calls_to_victims cv
INNER JOIN city_officials co
on co.name = cv.CALLER_NAME;

---Create a new view called “forum_posts_by_officials”. (Condition #2)
CREATE or replace VIEW forum_posts_by_officials  
AS SELECT DISTINCT 
NAME, 
DEPARTMENT,
POST_CATEGORY,
POST_TITLE,
POST_DATE
FROM city_officials
JOIN forum_activities 
ON IP_ADDRESS = USER_IP_ADDRESS
WHERE POST_TITLE ILIKE '%AI%';


SELECT 
Distinct(f.NAME)
from forum_posts_by_officials f
INNER JOIN calls_to_victims_by_officials c
ON f.NAME = c.CALLER_NAME;
---What city officials appear in both of these views?
---Gregory Hayes
---Omar Khan
---Linda Johnson


