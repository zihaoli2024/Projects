---------------------------------
--- Homework #5
--- Zihao Li
---------------------------------

-- Set the context.
USE ROLE sysadmin;
USE investigation.PUBLIC;
USE WAREHOUSE ghosts_loading_wh;

CREATE OR REPLACE STAGE investigation5921
    url = 's3://investigation-5921/';
LIST @investigation5921/;


----------------------------------
-- DATA
----------------------------------

---Query the city officials file in staging to explore it.
SELECT
$1,$2,$3,$4,$5,$6,$7,$8,$9
FROM
@investigation5921/city_officials_augmented.csv
LIMIT 100;
---What is the "official_id" for the first official in the staged file?
---101147

---Clear the "city_officials" table... since it has been tampered with.
DELETE FROM city_officials;

---Add a new column to the table -- "phone_directory_id". (We are reloading and enriching.)
ALTER TABLE city_officials
ADD COLUMN phone_directory_id integer;

Select * from city_officials;

---Reload the table using the file in staging. While doing so...
COPY INTO city_officials
FROM (
    SELECT
    $1,
    $2,
    $3,
    $4,    
    CASE
        WHEN $5 = 'Building 1' THEN 'Cultural'
        WHEN $5 = 'Building 2' THEN 'Downtown'
        WHEN $5 = 'Building 3' THEN 'Eastside'
        WHEN $5 = 'Building 4' THEN 'Harbor'
        WHEN $5 = 'Building 5' THEN 'Midtown'
        WHEN $5 = 'Building 6' THEN 'Riverside'
        WHEN $5 = 'Building 7' THEN 'Tech Hub'
        WHEN $5 = 'Building 8' THEN 'West'
    END,
    $7,
    $8,
    $9,
    $6
FROM @investigation5921/city_officials_augmented.csv (file_format => ghosts_csv)
);

---Then, query the entire table to confirm it loaded correctly. (Store results in Excel.)
SELECT * FROM city_officials;
---What is Charles Leeâ€™s office location? (Provide the name, not a building number.)
---Downtown



---Continue the Investigation

---Create a new view -- "calls_to_victims".
CREATE OR REPLACE VIEW calls_to_victims_view AS
SELECT
    vd.VICTIM_NAME AS VICTIM_NAME,
    cl.CALLER_ID AS CALLER_ID,
    pd.NAME as caller_name
FROM call_log cl
JOIN victim_detail_view vd 
ON cl.receiver_id = vd.DIRECTORY_ID
JOIN PHONE_DIRECTORY pd 
ON cl.CALLER_ID = pd.DIRECTORY_ID
WHERE DATEDIFF(day, cl.CALL_START_DATE, vd.HOMICIDE_DATE) BETWEEN 0 AND 14
AND cl.CALL_STATUS = 'answered'
ORDER BY vd.VICTIM_NAME, DATEDIFF(day, cl.CALL_START_DATE, vd.HOMICIDE_DATE);

---Then, query the view to confirm it loaded properly. (Store results in Excel.)
SELECT * FROM calls_to_victims_view;

---Query this view to only show calls from city officials.
SELECT
ca.VICTIM_NAME,
ca.CALLER_ID,
ca.CALLER_NAME,
FROM
calls_to_victims_view ca
inner join city_officials ci
on ca.CALLER_ID = ci.PHONE_DIRECTORY_ID;

---Which city official called Jane Patterson? Enter their phone ID.
---57650

SELECT
ca.VICTIM_NAME,
ca.CALLER_ID,
ca.CALLER_NAME,
vp.OCCUPATION,
vp.notes
FROM
calls_to_victims_view ca
inner join city_officials ci
on ca.CALLER_ID = ci.PHONE_DIRECTORY_ID
JOIN victim_profiles vp 
ON vp.VICTIM_NAME = ca.VICTIM_NAME
WHERE vp.notes ILIKE '%AI research%' 
   OR vp.notes ILIKE '%regulations%'
   OR vp.notes ILIKE '%investigative reporting%'
   OR vp.notes ILIKE '%investigative journalist%'
   OR vp.notes ILIKE '%community organizing%'
   OR vp.notes ILIKE '%social causes%'
   OR vp.notes ILIKE '%civil rights%';
---Which of the victims in the list were previously flagged as an activist, reporter, or researcher?
---Derek Stevens
---Guthry Greenslade
---Jane Patterson
---Jessica Morales


